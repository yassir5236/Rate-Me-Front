
<div class="max-w-6xl mx-auto p-8 rounded-lg shadow-xl">
  <h2 class="text-3xl font-semibold text-gray-800 mb-6">Gestion des Lieux</h2>

  <div class="">
    <button
      class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-semibold py-2 px-6 rounded-lg mb-6 transition-all duration-200 shadow-md hover:shadow-lg"
      (click)="openForm()"
    >
      ➕ Ajouter un lieu
    </button>

   

    <form class="max-w-lg mx-auto mb-5" (ngSubmit)="searchPlaces()" #searchForm>
      <div class="flex relative">
        <!-- Dropdown Button -->
        <button
          id="dropdown-button"
          type="button"
          class="flex-shrink-0 z-10 inline-flex items-center py-2.5 px-4 text-sm font-medium text-gray-600 bg-gray-100 border border-gray-300 rounded-s-lg hover:bg-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100"
          (click)="toggleDropdown()"
          [attr.aria-expanded]="isDropdownOpen"
          aria-haspopup="true"
        >
          {{ selectedCategory?.name || 'All categories' }}
          <svg
            class="w-2.5 h-2.5 ms-2.5 transition-transform duration-200"
            [class.rotate-180]="isDropdownOpen"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 10 6"
          >
            <path
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="m1 1 4 4 4-4"
            />
          </svg>
        </button>
    
        <!-- Dropdown Menu -->
        <div
          id="dropdown"
          class="z-20 bg-white divide-y divide-gray-100 rounded-lg shadow-md w-44 absolute top-full mt-1 left-0"
          [class.hidden]="!isDropdownOpen"
          role="menu"
          aria-labelledby="dropdown-button"
        >
          <ul class="py-2 text-sm text-gray-700">
            <li role="none">
              <button
                type="button"
                (click)="selectCategory(null)"
                class="w-full text-left px-4 py-2 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none"
                role="menuitem"
              >
                All categories
              </button>
            </li>
            <li *ngFor="let category of categories" role="none">
              <button
                type="button"
                (click)="selectCategory(category)"
                class="w-full text-left px-4 py-2 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none"
                role="menuitem"
              >
                {{ category.name }}
              </button>
            </li>
          </ul>
        </div>
    
        <!-- Search Input -->
        <div class="relative flex-1">
          <input
            type="search"
            [(ngModel)]="searchQuery"
            (input)="searchPlaces()"
            name="searchQuery"
            class="block w-full p-2.5 text-sm text-gray-900 rounded-e-lg  border border-gray-300 focus:ring-orange-500 focus:border-orange-500"
            placeholder="Search by name, category, or description..."
            aria-label="Search places"
          />
          <button
            type="submit"
            class="absolute top-0 end-0 p-2.5 h-full text-sm font-medium text-white bg-[#f59e42] rounded-e-lg border  hover:bg-orange-700 focus:ring-4 focus:ring-orange-200"
          >
            <svg
              class="w-4 h-4"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 20 20"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"
              />
            </svg>
            <span class="sr-only">Search</span>
          </button>
        </div>
      </div>
    </form>
    <div
      *ngIf="showForm"
      class="bg-gray-100 p-6 rounded-lg shadow-lg mb-8 max-w-3xl mx-auto"
    >
      <h3 class="text-2xl font-medium text-gray-800 mb-4">
        {{ placeForm.get("id")?.value ? "Modifier" : "Ajouter" }} un lieu
      </h3>
      <form [formGroup]="placeForm" (ngSubmit)="savePlace()" class="space-y-6">
        <div class="flex flex-col">
          <label for="name" class="text-gray-700 font-medium mb-2">Nom :</label>
          <input
            type="text"
            id="name"
            formControlName="name"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
          />
        </div>

        <div class="flex flex-col">
          <label for="description" class="text-gray-700 font-medium mb-2"
            >Description :</label
          >
          <textarea
            id="description"
            formControlName="description"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
          ></textarea>
        </div>

        <div class="flex flex-col">
          <label for="images" class="text-gray-700 font-medium mb-2"
            >Images :</label
          >
          <input
            type="file"
            id="images"
            multiple
            accept="image/*"
            (change)="onFilesSelected($event)"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
          />
        </div>

        <div class="grid grid-cols-3 gap-4">
          <div *ngFor="let image of selectedImages" class="relative">
            <img
              [src]="image.url"
              class="h-32 w-32 object-cover rounded-lg border-2 border-gray-200"
            />
            <button
              (click)="removeImage(image)"
              class="absolute top-0 right-0 bg-red-500 text-white rounded-full p-1 text-xs"
            >
              ❌
            </button>
          </div>
        </div>

        <div class="flex flex-col">
          <label for="address" class="text-gray-700 font-medium mb-2"
            >Adresse :</label
          >
          <input
            type="text"
            id="address"
            formControlName="address"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
          />
        </div>

        <div class="flex flex-col">
          <label for="latitude" class="text-gray-700 font-medium mb-2"
            >Latitude :</label
          >
          <input
            type="number"
            id="latitude"
            formControlName="latitude"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
          />
        </div>

        <div class="flex flex-col">
          <label for="longitude" class="text-gray-700 font-medium mb-2"
            >Longitude :</label
          >
          <input
            type="number"
            id="longitude"
            formControlName="longitude"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
          />
        </div>

        <div class="flex flex-col">
          <label for="averageRating" class="text-gray-700 font-medium mb-2"
            >Note moyenne :</label
          >
          <input
            type="number"
            id="averageRating"
            formControlName="averageRating"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
          />
        </div>

        <div class="flex flex-col">
          <label for="categoryId" class="text-gray-700 font-medium mb-2"
            >Catégorie :</label
          >
          <select
            id="categoryId"
            formControlName="categoryId"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
          >
            <option *ngFor="let category of categories" [value]="category.id">
              {{ category.name }}
            </option>
          </select>
        </div>

        <div class="flex justify-between space-x-4">
          <button
            type="submit"
            class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all duration-200"
          >
            ✅ Enregistrer
          </button>
          <button
            type="button"
            (click)="closeForm()"
            class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg transition-all duration-200"
          >
            ❌ Annuler
          </button>
        </div>
      </form>
    </div>

    <div
      *ngIf="showGallery"
      class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-8 z-50"
      (click)="closeGallery()"
    >
      <div
        class="bg-white rounded-lg shadow-xl max-w-4xl w-full p-6"
        (click)="$event.stopPropagation()"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-semibold text-gray-800">Gallery</h3>
          <button
            (click)="closeGallery()"
            class="text-gray-500 hover:text-gray-700"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="grid grid-cols-3 gap-4">
          <div *ngFor="let image of currentGallery" class="relative">
            <img
              [src]="image"
              alt="Gallery Image"
              class="rounded-lg shadow-lg h-48 w-full object-cover"
            />
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-8">
      <div
        *ngFor="let place of filteredPlaces"
        class="bg-white rounded-lg shadow-lg border border-gray-200"
      >
        <div class="p-4 flex items-center space-x-3 border-b border-gray-200">
          <button (click)="ToUserData(place.user?.id)">

          <img
            [src]="place.user?.profilePicture"
            alt="Profile Picture"
            class="h-10 w-10 rounded-full object-cover"
          />
        </button>

          <div>
            <h4 class="text-sm font-semibold text-gray-900">
             
              {{ place.user?.username }}
              
            </h4>
            <p class="text-xs text-gray-500">2 hours ago</p>
          </div>
        </div>

        <div class="p-4">
          <p class="text-lg font-medium text-green-500">#{{ place.name }}</p>
          <p class="text-sm text-gray-600">{{ place.description }}</p>
        </div>

        <div *ngIf="place.images && place.images.length > 0" class="p-4">
          <div class="grid grid-cols-2 gap-2">
            <div
              *ngFor="let image of place.images.slice(0, 2); let i = index"
              class="relative cursor-pointer"
              (click)="openGallery(place.images)"
            >
              <img
                [src]="image.path"
                alt="Image de {{ place.name }}"
                class="rounded-lg shadow-lg h-64 w-full object-cover"
              />
              <div
                *ngIf="i === 1 && place.images.length > 2"
                class="absolute inset-0 bg-black-10 flex items-center justify-center rounded-lg"
              >
                <span
                  class="text-black text-2xl font-bold bg-white p-2 rounded-full"
                >
                  +{{ place.images.length - 2 }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <p
          *ngIf="!place.images || place.images.length === 0"
          class="text-gray-500 p-4"
        >
          Aucune image disponible
        </p>
        <div *ngIf="showReviewForPlaceId === place.id" class="mt-6 p-10">
          <app-review [placeId]="place.id"></app-review>
        </div>

        <div class="p-4 border-t border-gray-200">
          <p class="text-sm text-gray-500 mb-2">
            Catégories: {{ place.category?.name }}
          </p>
          <div class="flex justify-between items-center">
            <div class="flex space-x-4">
              <button
                class="flex items-center text-gray-500 hover:text-blue-500"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"
                  />
                </svg>
                <span class="ml-2">Liked</span>
              </button>
              <button
                class="flex items-center text-gray-500 hover:text-green-500"
                (click)="toggleReviewSection(place.id)"
                [disabled]="!place.id"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123A7 7 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span class="ml-2">Comment</span>
              </button>
              <button
                class="flex items-center text-gray-500 hover:text-purple-500"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"
                  />
                </svg>
                <span class="ml-2">Share</span>
              </button>
            </div>

            @if(currentUserId2 === place.user?.id) {
            <div class="flex space-x-2">
              <button
                (click)="openForm(place)"
                class="text-gray-500 hover:text-yellow-500"
              >
                ✏️
              </button>
              <button
                (click)="place.id && deletePlace(place.id)"
                class="text-gray-500 hover:text-red-500"
              >
                🗑️
              </button>
            </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
